var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6-impl","es3");
var _this=this,passport=require("passport"),LocalStrategy=require("passport-local").Strategy,FacebookStrategy=require("passport-facebook").Strategy,jwt=require("jsonwebtoken"),fs=require("fs"),api=require("./v1-api.js"),user=require("./db-structure/user.js");
this.checkAPIpermission=function(a,b,c){var d=a.params.lv3;_this.log("*** API called: "+a.params.lv3);api.permission[d]?-1<api.permission[d].indexOf("public")?c():a.decoded?-1<api.permission[d].indexOf(a.decoded.userPermission)?c():b.status(403).json({errorCode:403,errorMessage:"Access denied, additional priviledge required!"}):b.status(401).json({errorCode:401,errorMessage:"You are not authenticated, please login to proceed!"}):b.status(404).json({errorCode:404,errorMessage:"API not exist or registered"})};
this.callAPI=function(a,b,c){var d=a.params.lv3;c=api[d];try{c(a,b,function(a,c){if(a){var f=_this.errRes(d,a);return b.status(a.statusCode||"500").json(f)}f={SUCCESS:"api called: '"+d+"'"};for(var e in c)f[e]=c[e];return b.status("200").json(f)})}catch(e){return a=_this.errRes(d,e),b.status(e.statusCode||"500").json(a)}};this.getToken=function(a,b){return jwt.sign(a,process.env.JWT_SECRET,{expiresIn:b})};this.reportSystemMaster=function(a){api.reportError(a)};
this.getUser=function(a,b,c){a.decoded?user.findById(a.decoded.username).then(function(b){a.user=b;c()}).catch(function(b){a.user=!1;c()}):(a.user=!1,c())};this.checkAccessToken=function(a,b,c){a.cookies["x-access-token"]?jwt.verify(a.cookies["x-access-token"].token,process.env.JWT_SECRET,function(b,e){a.decoded=b?!1:e;c()}):(a.decoded=!1,c())};
this.headerParser=function(a,b,c){"production"!==process.env.NODE_ENV?(a.HOST_NAME=a.get("host"),a.REAL_IP=a.ip):(a.HOST_NAME=a.headers["x-host-name"],a.REAL_IP=a.headers["x-real-ip"]);c()};this.initSocketIO=function(a){_this.io=a;var b=[];a.on("connection",function(a){b.push(a);console.log("Connect: %s connected",b.length);a.on("disconnect",function(a){b.splice(b.indexOf(a),1);console.log("Disconnect: %s connnected",b.length)})})};
this.initPassport=function(a){a.use(passport.initialize());passport.use(new LocalStrategy(user.authenticate()));passport.serializeUser(user.serializeUser());passport.deserializeUser(user.deserializeUser());passport.use(new FacebookStrategy({clientID:process.env.FB_CLIENT_ID,clientSecret:process.env.FB_CLIENT_SEC,callbackURL:process.env.FB_CALLBACK_URL,profileFields:"email id displayName name gender picture.type(large)".split(" ")},function(a,c,d,e){d._json.email?user.findById(d._json.email).then(function(b){if(b)return e(null,
b);b=api.download(d._json.picture.data.url);user.create({_id:d._json.email,username:d._json.email,email:d._json.email,firstName:d._json.first_name,lastName:d._json.last_name,avatar:b,userPermission:"user",emailVerified:!0,facebook:{OauthId:d._json.id,OauthToken:a}}).then(function(a){e(null,a)}).catch(function(a){e(a,null)})}).catch(function(a){return e(a,null)}):e({name:"NO EMAIl",message:"Login with Facebook failed. Your Facebook account has no email."},null)}))};
this.envWiseConfig=function(a,b,c,d){if("production"!==process.env.NODE_ENV){var e=require("util");e.inspect.styles={special:"green",number:"blue",boolean:"red",undefined:"red",null:"red",string:"magenta",symbol:"green",date:"blue",regexp:"green"};c.errRes=function(a,b){return{ERROR:"api called: '"+a+"'",errorName:b.name,errorMessage:b.message,errorStack:b.stack}};c.log=function(a,b,c,d,g){b?c?d?g?console.log(a,b,c,d,g):console.log(a,b,c,d):console.log(a,b,c):console.log(a,b):console.log(e.inspect(a,
{showHidden:!0,depth:null,colors:!0}))};c.printDup=function(a){var b=[];console.log("*** printing tags:");for(tag1 in a.s)if(b.push(tag1),console.log("\t %s",tag1),a.s[tag1].s)for(tag2 in a.s[tag1].s)if(b.push(tag2),console.log("\t\t %s, %s",tag1,tag2),a.s[tag1].s[tag2].s)for(tag3 in a.s[tag1].s[tag2].s)if(b.push(tag3),console.log("\t\t\t %s, %s, %s",tag1,tag2,tag3),a.s[tag1].s[tag2].s[tag3].s)for(tag4 in a.s[tag1].s[tag2].s[tag3].s)if(b.push(tag4),console.log("\t\t\t\t %s, %s, %s, %s",tag1,tag2,
tag3,tag4),a.s[tag1].s[tag2].s[tag3].s[tag4].s)for(tag5 in a.s[tag1].s[tag2].s[tag3].s[tag4].s)b.push(tag5),console.log("\t\t\t\t\t %s, %s, %s, %s, %s",tag1,tag2,tag3,tag4,tag5);var c=b.map(function(a){return{count:1,name:a}}).reduce(function(a,b){a[b.name]=(a[b.name]||0)+b.count;return a},{});a=Object.keys(c).filter(function(a){return 1<c[a]});console.log("*** printing duplicate tags array:");console.log(a)}}else c.errRes=function(a,b){return{ERROR:"api called: '"+a+"'",errorName:b.name,errorMessage:b.message}},
c.log=function(){},c.printDup=function(){}};this.renderNotFound=function(a,b,c){b.render("notFound")};this.allRequestErrorHandler=function(a,b,c,d){c.status(a.status||500).json(a)};this.renderPage=function(a,b,c){api.renderPage(a,b,c)};this.renderPost=function(a,b,c){api.renderPost(a,b,c)};this.renderBlog=function(a,b,c){api.renderBlog(a,b,c)};
